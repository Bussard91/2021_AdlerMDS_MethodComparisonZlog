---
title: "MVZ Labor Prof. Schenk/Dr. Ansorge und Kollegen - Methodenvergleich"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Einführung

Mit diesem Dokument steht Ihnen eine **interaktive** Möglichkeit eines **Methodenvergleiches** zur Verfügung. Sie können direkt in dieses Dokument Ihre Daten laden und die Auswertung direkt hier durchführen. Am Ende des Dokumentes finden Sie einen Download-Button um diese Auswertung als PDF-Datei herunterzuladen.

## Geräte-/Testnamen eintragen

```{r Daten, echo=FALSE, message=FALSE, warning=FALSE}
inputPanel(
  fluidRow(
    column(10, textInput("Gerät1", "Name des alten Gerätes/Tests:", value = NULL))
  ),
  fluidRow(
    column(12, textInput("Gerät2", "Name des neuen Gerätes/Tests:", value = NULL), offset = 2)
  )
)
```

## Daten hochladen

Hier können Sie eine Datei auswählen und hochladen. Es muss sich um eine **.csv**-Datei handeln und die Spalten müssen immer in folgender Form formatiert sein:

Messung | Parameter alt | Parameter neu
--------|---------------|--------------
1       |Messwert 1     |Messwert 1
2       |Messwert 2     |Messwert 2

Wählen Sie hier eine Datei aus:

```{r Data, echo=FALSE}
inputPanel(
  fileInput("Datei", "Datei auswählen", multiple = FALSE, accept = c("text/csv", "text/comma-separated-values,text/plain",".csv")),
  radioButtons("Sep", "Spalten-Separationszeichen", choices = c(Komma = ",", Semikolon = ";"), selected = ";")
)

renderDataTable({
  req(input$Datei)
    tryCatch({
      df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    },
    error = function(e){
      stop(safeError(e))
    })
})
```

\newpage

## Regression

Nachfolgend wird hier die Regressionsanalyse durchgeführt. Sie können wählen zwischen verschiedenen **Regressionsmethoden**:

```{r Regression-Options, echo=FALSE}
inputPanel(
  textInput("Name", "Name des Parameters:", ""),
  textInput("Einheit", "Einheit des Parameters:", ""),
  radioButtons("Methode", "Regressionsmethode:", c("klassische lineare Regression" = "Linear", "Deming-Regression" = "Deming", "Passing-Bablock-Regression" = "Passing"))
)
```

```{r Regression, echo=FALSE, out.height=10}
renderPlot({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    Methodenauswahl <- switch(input$Methode, "Linear" = "WLinReg", "Deming" = "Deming", "Passing" = "PaBa")
    library(mcr)
    Model <- mcreg(df$Parameter.alt, df$Parameter.neu, method.reg = Methodenauswahl)
    XAchse <- paste(input$Name, "alt in", input$Einheit)
    YAchse <- paste(input$Name, "neu in", input$Einheit)
    Titel <- paste("Methodenvergleich", input$Name)
    Regressionsplot <- MCResult.plot(Model, x.lab = XAchse, y.lab = YAchse, main = Titel)
    Regressionsplot
  },
  error = function(e){
    stop(safeError(e))
  })
}, height = 800)
```

\newpage

**Der Korrelationskoeffizient beträgt:**

```{r Korrelationskoeffizient, echo=FALSE}
renderPrint({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    cor(df$Parameter.neu, df$Parameter.alt)
  },
  error = function(e){
    stop(safeError(e))
  })  
})
```

**Führt man einen Korrelationstest durch, ergibt sich folgendes Ergebnis:**

```{r Korrelationstest, echo=FALSE}
renderPrint({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    cor.test(df$Parameter.neu, df$Parameter.alt)
  },
  error = function(e){
    stop(safeError(e))
  })
})
```

**Dementsprechend berechnet sich das Bestimmheitsmaß (r², Determinationskoeffizient) wie folgt:**

```{r Bestimmheitsmaß, echo=FALSE}
renderPrint({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    Deter <- cor(df$Parameter.neu, df$Parameter.alt)
    Deter^2
  },
  error = function(e){
    stop(safeError(e))
  })
})
```

**Die Differenzen zwischen den Messergebnissen beider Methoden (Neu - Alt) lassen sich wie folgt zusammenfassen:**

```{r SumDifferenz, echo=FALSE}
renderPrint({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    df$Differenz <- df$Parameter.neu - df$Parameter.alt
    summary(df$Differenz)
  },
  error = function(e){
    stop(safeError(e))
  })
})
```

**Das Histogramm der Differenzen (Neu - Alt) stellt sich wie folgt dar:**

```{r Hist, echo=FALSE, message=FALSE, warning=FALSE}
renderPlot({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    df$Differenz <- df$Parameter.neu - df$Parameter.alt
    hist(df$Differenz, main = "Histogramm der Differenzen zwischen neuer und alter Methode", ylab = "Häufigkeit",
         xlab = paste("Differenz", input$Name, "in", input$Einheit), col = "lightblue")
  },
  error = function(e){
    stop(safeError(e))
  })
})
```

**Der Variationskoeffizient (in %) der Differenzen liegt bei:**

```{r VK, echo=FALSE}
renderPrint({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    df$DifferenzProz <- (df$Parameter.neu*100)/df$Parameter.alt
    VK <- (sd(df$DifferenzProz)*100)/mean(df$DifferenzProz)
    VK
  },
  error = function(e){
    stop(safeError(e))
  })
})
```

\newpage

## Bland-Altman-Plot

Zur Analyse der Abweichung zwischen den Messungen beider Methoden kommt der **Bland-Altman-Plot** zur Anwendung.

```{r Bland-Altman-Plot, echo=FALSE}
renderPlot({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    Methodenauswahl <- switch(input$Methode, "Linear" = "WLinReg", "Deming" = "Deming", "Passing" = "PaBa")
    Model <- mcreg(df$Parameter.alt, df$Parameter.neu, method.reg = Methodenauswahl)
    XAchse2 <- paste("(", input$Name, "alt +", input$Name, "neu) / 2")
    YAchse2 <- paste(input$Name, "neu -", input$Name, "alt")
    Titel <- paste("Bland-Altman-Plot", input$Name)
    Bland.Altman <- MCResult.plotDifference(Model, xlab = XAchse2, ylab = YAchse2, main = Titel)
    Bland.Altman
  },
  error = function(e){
    stop(safeError(e))
  })
}, height = 800)
```

\newpage

## zlog-Plot

Um die Messergebnisse in Bezug auf das Referenzintervall miteinander zu vergleichen, können die Messwerte bezogen auf das jeweilige Referenzintervall in ihre **zlog-Werte** umgerechnet werden. Werte innerhalb des Referenzintervalles werden somit unabhängig von der Einheit und der Größenordnung des Parameters in **Werte zwischen -1,96 (-2 Standardabweichungen, 2,5. Perzentile) und +1,96 (+2 Standardabweichungen, 97,5. Perzentile)** umgerechnet. So kann besser eingeschätzt werden, ob die mit beiden Methoden gemessenen Werte ähnlich nah oder entfernt von den Referenzintervallen liegen. So kann zu einem gewissen Teil die klinische Interpretation verstärkt in den Methodenvergleich mit eingebracht werden.

```{r zlog-Input, echo=FALSE, message=FALSE, warning=FALSE}
inputPanel(
  numericInput("UG1", "Untergrenze Methode 1:", value = NULL),
  numericInput("OG1", "Obergrenze Methode 1:", value = NULL),
  numericInput("UG2", "Untergrenze Methode 2:", value = NULL),
  numericInput("OG2", "Obergrenze Methode 2:", value = NULL)
)
```


```{r zlog-Plot, echo=FALSE, message=FALSE, warning=FALSE}
renderPlot({
  req(input$Datei)
  tryCatch({
    df <- read.csv(input$Datei$datapath, header = T, sep = input$Sep)
    zlog1 <- function(x){
    Wert <- (log(x) - (log(input$UG1) + log(input$OG1))/2) * (3.92 / (log(input$OG1) - log(input$UG1)))
    return(round(Wert,2))
    }
    df$zlog.alt <- sapply(df$Parameter.alt, zlog1)
    zlog2 <- function(x){
    Wert <- (log(x) - (log(input$UG2) + log(input$OG2))/2) * (3.92 / (log(input$OG2) - log(input$UG2)))
    return(round(Wert,2))
    }
    df$zlog.neu <- sapply(df$Parameter.neu, zlog2)
    df$Index <- seq(from = 1, to = length(df$Parameter.alt), by = 1)
    plot(df$Index, df$zlog.alt, pch = 16, col = "blue",
         main = paste("Zlog-Werte als Ausdruck der Abweichung in Standardabweichungen", input$Name), xlab = "Messpaar",
         ylab = paste("zlog", input$Name), ylim = c(-10, 10), las = T)
    points(df$zlog.neu, pch = 16, col = "red")
    abline(h = 1.96, lwd = 2)
    abline(h = -1.96, lwd = 2)
    text(df$zlog.alt, labels = rownames(df), pos = 4)
    text(df$zlog.neu, labels = rownames(df), pos = 4)
    legend(x = 1, y = -8, legend = c("alte Methode", "neue Methode"), col = c("blue", "red"), pch = 16, cex = 1.2)
  },
  error = function(e){
    stop(safeError(e))
  })
}, height = 800)
```


#### Name des Durchführenden

```{r Name, echo=FALSE}
inputPanel(
  textInput("Name", "Name:", value = ""),
  textInput("Unterschrift", "Unterschrift:", value = "")
)
```
